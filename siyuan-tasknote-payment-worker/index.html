<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Zpay 支付示例</title>
    <style>
        #qrcode {
            width: 200px;
            height: 200px;
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>

<body>
    <h1>商品：任务笔记管理插件会员测试订阅</h1>
    <p>价格：0.01 元</p>
    <button id="payButton">使用支付宝支付</button>
    <button id="checkButton" disabled>查询订单状态</button>
    <div id="payment-status">请扫描下方二维码完成支付</div>
    <div id="qrcode"></div>

    <script>
        const payButton = document.getElementById('payButton');
        const API_PREFIX = 'https://siyuan-tasknote.achuan-2.top'; // API 前缀地址
        const qrcodeContainer = document.getElementById('qrcode');
        const statusDiv = document.getElementById('payment-status');
        // qrCode 已移除，前端仅使用后端返回的图片链接显示二维码
        let orderId = null; // 用于存放我们的商户订单号

        payButton.addEventListener('click', async () => {
            payButton.disabled = true;
            payButton.textContent = '正在生成二维码...';

            try {
                // 1. 请求我们自己的后端来创建支付订单
                const response = await fetch(`${API_PREFIX}/api/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: '任务笔记管理插件会员测试订阅',
                        money: '0.01', // 注意：金额是字符串,
                        term:'7d',
                        userId:"1610205759005"
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // 2. 后端成功返回了二维码链接和订单号
                    orderId = result.out_trade_no;
                    const imgUrl = result.img;

                    // 3. 只使用后端返回的图片链接显示二维码（不回退到 qrcode.js）
                    qrcodeContainer.innerHTML = ''; // 清空之前的二维码
                    if (imgUrl) {
                        const img = document.createElement('img');
                        img.src = imgUrl;
                        img.alt = '支付二维码';
                        img.style.width = '200px';
                        img.style.height = '200px';
                        qrcodeContainer.appendChild(img);

                        statusDiv.textContent = '二维码已生成，请使用支付宝扫描';
                        // 启用手动查询按钮
                        checkButton.disabled = false;
                    } else {
                        alert('未收到可用的二维码图片，请稍后重试');
                        payButton.disabled = false;
                        payButton.textContent = '使用支付宝支付';
                    }
                    // 已禁用自动轮询，使用手动查询按钮或等待异步通知

                } else {
                    alert('创建订单失败: ' + result.message);
                    payButton.disabled = false;
                    payButton.textContent = '使用支付宝支付';
                }
            } catch (error) {
                console.error('请求失败:', error);
                alert('网络错误，请稍后再试');
                payButton.disabled = false;
                payButton.textContent = '使用支付宝支付';
            }
        });

        // 手动查询订单状态（不使用后台轮询）
        const checkButton = document.getElementById('checkButton');
        checkButton.addEventListener('click', async () => {
            if (!orderId) {
                alert('没有可查询的订单号');
                return;
            }
            checkButton.disabled = true;
            checkButton.textContent = '查询中...';
            try {
                const response = await fetch(`${API_PREFIX}/api/check-status?out_trade_no=${orderId}`);
                const result = await response.json();

                const statusNum = Number(result.status);
                if (statusNum === 1) {
                    statusDiv.textContent = '支付成功！感谢您的购买。';
                    statusDiv.style.color = 'green';
                    qrcodeContainer.innerHTML = '<h2>支付成功</h2>';
                    payButton.style.display = 'none';
                    checkButton.style.display = 'none';
                } else if (statusNum === 0) {
                    statusDiv.textContent = '订单未支付';
                    statusDiv.style.color = 'orange';
                    console.log('订单未支付');
                } else {
                    statusDiv.textContent = result.message || '查询失败';
                    console.log(result.message || '查询失败');
                }
            } catch (error) {
                console.error('查询状态时出错:', error);
                alert('查询失败，请稍后重试');
            } finally {
                if (checkButton.style.display !== 'none') {
                    checkButton.disabled = false;
                    checkButton.textContent = '查询订单状态';
                }
            }
        });

    </script>
</body>

</html>